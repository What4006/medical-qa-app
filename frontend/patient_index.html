<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>医智通 - 病人端首页</title>
  <!-- 基础样式与脚本 -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

<!-- Tailwind配置 -->
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        patient: { // 病人端主色：淡蓝色
          50: '#f0f7ff', 100: '#e0efff', 200: '#b9ddff', 
          300: '#7cc3fc', 400: '#3d9fe8', 500: '#0a84e3', 
          600: '#0066c7', 700: '#0052a3', 800: '#004382'
        },
        doctor: { // 医护端主色：淡青色
          50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 
          300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 
          600: '#0d9488', 700: '#0f766e', 800: '#115e59'
        },
        success: '#10b981', warning: '#f59e0b', danger: '#ef4444'
      },
      fontFamily: {
        sans: ['Microsoft YaHei', 'Source Han Sans CN', 'sans-serif']
      }
    }
  }
}
</script>

<style type="text/tailwindcss">
@layer utilities {
  .content-auto { content-visibility: auto; }
  .transition-300 { transition: all 300ms ease; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .backdrop-blur { backdrop-filter: blur(8px); }
  .clickable-card { cursor: pointer; }
  .ai-initial { @apply font-bold text-sm; }
  .skeleton { @apply bg-neutral-200 animate-pulse rounded; }
}
</style>

<style>
/* 消息弹窗动画 */
#notification-popup {
  transform-origin: top right;
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.notification-item {
  border-bottom: 1px solid #f1f5f9;
}

.notification-item:last-child {
  border-bottom: none;
}

.notification-item:hover {
  background-color: #f8fafc;
}
</style>
</head>
<body class="bg-neutral-50 min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur shadow-sm transition-300">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-patient-500 to-doctor-500 flex items-center justify-center">
          <i class="fa fa-heartbeat text-white text-xl"></i>
        </div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-patient-600 to-doctor-600 bg-clip-text text-transparent">医智通</h1>
      </div>

      <!-- 移动端菜单按钮 -->
      <button id="mobile-menu-btn" class="md:hidden text-neutral-700 hover:text-patient-500 transition-300">
        <i class="fa fa-bars text-xl"></i>
      </button>

      
      <div class="hidden md:flex items-center space-x-6">
        <!-- 消息通知按钮及弹窗 -->
        <div class="relative">
          <button id="notification-btn" class="text-neutral-600 hover:text-patient-500 transition-300 focus:outline-none">
            <i class="fa fa-bell text-xl"></i>
            <!-- 在原代码中找到消息徽章的HTML部分，替换为： -->
            <span class="absolute -top-1 -right-1 w-4 h-4 bg-danger text-white text-xs rounded-full flex items-center justify-center" id="notification-badge"></span>
          </button>
          
          <!-- 消息弹窗 - 增大宽度和最大高度 -->
          <div id="notification-popup" class="hidden absolute right-0 mt-2 w-96 md:w-112 bg-white rounded-lg shadow-lg border border-neutral-200 z-50 overflow-hidden">
            <div class="p-3 bg-neutral-50 border-b border-neutral-200">
              <h3 class="font-medium text-neutral-800">预约消息</h3>
            </div>
            <div id="notification-content" class="max-h-96 overflow-y-auto scrollbar-hide">
              <!-- 加载状态 -->
              <div id="notification-loading" class="p-4 text-center">
                <i class="fa fa-circle-o-notch fa-spin text-patient-500 text-xl mb-2"></i>
                <p class="text-neutral-500 text-sm">加载中...</p>
              </div>
              
              <!-- 空状态 -->
              <div id="notification-empty" class="hidden p-6 text-center">
                <div class="w-12 h-12 mx-auto bg-neutral-100 rounded-full flex items-center justify-center mb-2">
                  <i class="fa fa-calendar-o text-neutral-400 text-xl"></i>
                </div>
                <p class="text-neutral-500 text-sm">暂无待处理的预约</p>
              </div>
            </div>
            <div class="p-2 bg-neutral-50 border-t border-neutral-200">
              <a href="patient_book.html" class="block text-center text-patient-600 hover:text-patient-700 text-sm font-medium transition-300">
                更多预约
              </a>
            </div>
          </div>
        </div>
        
        <div>
          <button class="text-neutral-700 hover:text-patient-500 transition-300">
            <i class="fa fa-cog text-2xl"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 移动端菜单 -->
    <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-neutral-200">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center space-x-1 bg-neutral-100 rounded-full p-1 mb-4">
          <button class="flex-1 px-4 py-2 rounded-full text-sm font-medium bg-patient-500 text-white text-center transition-300">病人端</button>
        </div>
        <nav class="space-y-1">
          <a href="patient_index.html" class="block py-2 px-3 rounded-lg bg-patient-50 text-patient-700 font-medium">首页</a>
          <a href="patient_ai.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">AI问诊</a>
          <a href="patient_book.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">预约医生</a>
          <a href="patient_MyMR.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">我的病历</a>
          <a href="patient_MyCenter.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">个人中心</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-1 pt-16">
    <div class="container mx-auto px-4 py-6">
      <!-- 欢迎信息 - 动态显示用户名 -->
      <div class="mb-8 bg-gradient-to-r from-patient-500 to-patient-700 rounded-2xl p-6 text-white shadow-lg">
        <div>
          <h2 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold mb-2">
            您好，<span id="user-nickname" class="skeleton inline-block h-7"></span>
          </h2>
          <p class="text-patient-100 max-w-md">今天感觉怎么样？AI助手和专业医生随时为您提供帮助</p>
        </div>
      </div>

      <!-- 核心功能区（跳转入口） -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <a href="patient_ai.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-stethoscope text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">开始AI问诊</h3>
        </a>

        <a href="patient_book.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-calendar-check-o text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">预约医生</h3>
        </a>

        <a href="patient_MyMR.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-file-text-o text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">我的病历</h3>
        </a>

        <a href="patient_MyCenter.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-user-o text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">个人中心</h3>
        </a>
      </div>

      <!-- 最近问诊 -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-neutral-800">最近问诊</h2>
          <a href="patient_chat_record.html" class="text-patient-600 hover:text-patient-700 text-sm font-medium flex items-center">
            全部记录 <i class="fa fa-angle-right ml-1"></i>
          </a>
        </div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <div class="divide-y divide-neutral-100" id="recent-consultation-container">
            <!-- 加载状态 -->
            <div id="loading-recent" class="p-6 text-center">
              <i class="fa fa-circle-o-notch fa-spin text-patient-500 text-xl mb-2"></i>
              <p class="text-neutral-500">加载最近问诊记录中...</p>
            </div>
            
            <!-- 空状态 (默认隐藏) -->
            <div id="empty-recent" class="hidden p-6 text-center">
              <div class="w-16 h-16 mx-auto bg-neutral-100 rounded-full flex items-center justify-center mb-3">
                <i class="fa fa-file-text-o text-neutral-400 text-2xl"></i>
              </div>
              <p class="text-neutral-500">暂无问诊记录</p>
            </div>
            
            <!-- 记录内容将通过JavaScript动态生成 -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 底部 -->
  <footer class="bg-white border-t border-neutral-200 py-6">
    <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
      <p>© 2024 医智通 版权所有 | 数据传输加密 隐私合规</p>
      <div class="flex justify-center space-x-4 mt-3">
        <a href="#" class="hover:text-patient-500 transition-300">隐私政策</a>
        <a href="#" class="hover:text-patient-500 transition-300">用户协议</a>
        <a href="#" class="hover:text-patient-500 transition-300">客服中心</a>
      </div>
    </div>
  </footer>

  <!-- 交互脚本 -->
  <script src="js/services/apiService.js"></script> 
  <script>
    // 移动端菜单切换
    document.getElementById('mobile-menu-btn').addEventListener('click', function() {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // 导航栏滚动效果
    window.addEventListener('scroll', function() {
      const header = document.querySelector('header');
      header.classList.toggle('shadow', window.scrollY > 10);
    });

    // 消息弹窗交互
    document.addEventListener('DOMContentLoaded', function() {
      const notificationBtn = document.getElementById('notification-btn');
      const notificationPopup = document.getElementById('notification-popup');
      
      // 点击消息按钮显示/隐藏弹窗
      notificationBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        notificationPopup.classList.toggle('hidden');
        // 只有在显示弹窗时才加载数据
        if (!notificationPopup.classList.contains('hidden')) {
          fetchPendingAppointments();
        }
      });
      
      // 点击页面其他地方关闭弹窗
      document.addEventListener('click', function() {
        notificationPopup.classList.add('hidden');
      });
      
      // 点击弹窗内部不关闭弹窗
      notificationPopup.addEventListener('click', function(e) {
        e.stopPropagation();
      });

      // 页面加载时获取用户信息和最近问诊记录
      fetchUserInfo();
      fetchRecentConsultation();
      // 检查是否有未处理的预约，更新消息徽章
      checkPendingAppointments();
    });

    // 检查是否有未处理的预约，用于更新消息徽章
    function checkPendingAppointments() {
      apiService.getPendingAppointments()
        .then(appointments => {
          const badge = document.getElementById('notification-badge');
          if (appointments && appointments.length > 0) {
            badge.style.display = 'flex';
            // 显示预约数量
            badge.textContent = appointments.length > 9 ? '9+' : appointments.length;
          } else {
            badge.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('检查未处理预约失败:', error);
        });
    }

    // 获取最新的待处理预约信息
    function fetchPendingAppointments() {
      apiService.getPendingAppointments()
        .then(appointments => {
          renderAppointments(appointments);
        })
        .catch(error => {
          console.error('加载最新预约失败:', error);
          const content = document.getElementById('notification-content');
          content.innerHTML = `
            <div class="p-4 text-center">
              <i class="fa fa-exclamation-circle text-danger text-xl mb-2"></i>
              <p class="text-neutral-500 text-sm">加载失败</p>
            </div>
          `;
        });
    }

    // 渲染预约信息 - 修改为显示所有预约
    function renderAppointments(appointments) {
      const content = document.getElementById('notification-content');
      
      // 清空内容
      content.innerHTML = '';
      
      // 检查是否有预约
      if (!appointments || appointments.length === 0) {
        content.innerHTML = `
          <div class="p-6 text-center">
            <div class="w-12 h-12 mx-auto bg-neutral-100 rounded-full flex items-center justify-center mb-2">
              <i class="fa fa-calendar-o text-neutral-400 text-xl"></i>
            </div>
            <p class="text-neutral-500 text-sm">暂无待处理的预约</p>
          </div>
        `;
        return;
      }
      
      // 显示所有等待状态的预约
      appointments.forEach(appointment => {
        // 创建预约信息元素
        const appointmentItem = document.createElement('div');
        appointmentItem.className = 'notification-item p-4';
        
        // 格式化日期显示
        const formattedDate = formatDate(appointment.appointmentDate);
        
        appointmentItem.innerHTML = `
          <div class="flex items-start">
            <div class="w-8 h-8 rounded-full bg-doctor-100 flex items-center justify-center mr-3 mt-0.5">
              <i class="fa fa-user-md text-doctor-600 text-sm"></i>
            </div>
            <div class="flex-1">
              <p class="text-neutral-800 text-sm font-medium">您预约了${appointment.doctorName}（${appointment.department}）</p>
              <p class="text-neutral-600 text-xs mt-1">
                日期: ${formattedDate} ${appointment.appointmentTime}
              </p>
              <p class="text-neutral-600 text-xs mt-1">
                状态: <span class="text-warning">等待确认</span>
              </p>
              <p class="text-neutral-500 text-xs mt-2">
                预约时间: ${appointment.createdAt}
              </p>
            </div>
          </div>
        `;
        
        content.appendChild(appointmentItem);
      });
    }

    // 格式化日期显示 (YYYY-MM-DD -> MM月DD日)
    function formatDate(dateString) {
      const date = new Date(dateString);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}月${day}日`;
    }

    // 获取当前登录用户信息函数
    function fetchUserInfo() {
      // 调用apiService中的getCurrentUser方法
      apiService.getCurrentUser()
        .then(userInfo => {
          // 更新页面显示的用户名
          const nicknameElement = document.getElementById('user-nickname');
          nicknameElement.textContent = userInfo.nickname;
          // 移除骨架屏样式
          nicknameElement.classList.remove('skeleton');
        })
        .catch(error => {
          console.error('加载用户信息失败:', error);
          // 出错时显示默认名称
          const nicknameElement = document.getElementById('user-nickname');
          nicknameElement.textContent = '用户';
          nicknameElement.classList.remove('skeleton');
        });
    }

    // 获取最近的问诊记录函数
    function fetchRecentConsultation() {
      // 调用获取最近一条记录的API
      apiService.getRecentMedicalRecord()
        .then(recentRecord => {
          renderRecentConsultation(recentRecord);
        })
        .catch(error => {
          console.error('加载最近问诊记录失败:', error);
          document.getElementById('loading-recent').innerHTML = `
            <div class="p-6 text-center">
              <i class="fa fa-exclamation-circle text-danger text-xl mb-2"></i>
              <p class="text-neutral-500">加载失败</p>
            </div>
          `;
        });
    }

    // 渲染最近的问诊记录
    function renderRecentConsultation(record) {
      const container = document.getElementById('recent-consultation-container');
      
      // 隐藏加载状态
      document.getElementById('loading-recent').remove();
      
      if (!record) {
        // 显示空状态
        document.getElementById('empty-recent').classList.remove('hidden');
        return;
      }
      
      // 根据记录类型(AI或医生)设置不同的图标和样式
      let iconHtml, typeText;
      if (record.type === 'ai') {
        // 使用"AI"文字作为头像图标
        iconHtml = '<div class="ai-initial">AI</div>';
        typeText = `${record.title}`;
      } else {
        iconHtml = '<i class="fa fa-user-md text-doctor-600"></i>';
        typeText = `${record.title} · ${record.department}`;
      }
      
      // 创建记录卡片
      const card = document.createElement('div');
      card.className = 'block p-4 hover:bg-neutral-50 transition-300 clickable-card';
      card.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full bg-patient-100 flex items-center justify-center mr-3">
              ${iconHtml}
            </div>
            <div>
              <h3 class="font-medium text-neutral-800">${typeText}</h3>
              <p class="text-neutral-500 text-sm">${record.date} ${record.time} ${record.doctor ? '· ' + record.doctor : ''}</p>
            </div>
          </div>
          <span class="px-2 py-1 bg-patient-100 text-patient-700 text-xs rounded-full">${record.status === 'completed' ? '已完成' : '进行中'}</span>
        </div>
        <p class="text-neutral-700 ml-13">${record.summary}</p>
      `;
      
      container.appendChild(card);
    }

    // 处理问诊记录点击事件
    document.addEventListener('click', function(e) {
      if (e.target.closest('.clickable-card')) {
        console.log('打开问诊记录详情');
        // 这里可以添加跳转到详情页的逻辑
      }
    });
  </script>
</body>
</html>