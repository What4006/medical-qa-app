<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>医智通 - 病人端首页</title>
  <!-- 基础样式与脚本 -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

<!-- Tailwind配置 -->
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        patient: { // 病人端主色：淡蓝色
          50: '#f0f7ff', 100: '#e0efff', 200: '#b9ddff', 
          300: '#7cc3fc', 400: '#3d9fe8', 500: '#0a84e3', 
          600: '#0066c7', 700: '#0052a3', 800: '#004382'
        },
        doctor: { // 医护端主色：淡青色
          50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 
          300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 
          600: '#0d9488', 700: '#0f766e', 800: '#115e59'
        },
        success: '#10b981', warning: '#f59e0b', danger: '#ef4444'
      },
      fontFamily: {
        sans: ['Microsoft YaHei', 'Source Han Sans CN', 'sans-serif']
      }
    }
  }
}
</script>

<style type="text/tailwindcss">
@layer utilities {
  .content-auto { content-visibility: auto; }
  .transition-300 { transition: all 300ms ease; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .backdrop-blur { backdrop-filter: blur(8px); }
  .clickable-card { cursor: pointer; }
  .ai-initial { @apply font-bold text-sm; }
  .skeleton { @apply bg-neutral-200 animate-pulse rounded; }
}
</style>
</head>
<body class="bg-neutral-50 min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur shadow-sm transition-300">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-patient-500 to-doctor-500 flex items-center justify-center">
          <i class="fa fa-heartbeat text-white text-xl"></i>
        </div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-patient-600 to-doctor-600 bg-clip-text text-transparent">医智通</h1>
      </div>

      <!-- 移动端菜单按钮 -->
      <button id="mobile-menu-btn" class="md:hidden text-neutral-700 hover:text-patient-500 transition-300">
        <i class="fa fa-bars text-xl"></i>
      </button>

      
      <div class="hidden md:flex items-center space-x-6">
        <div class="relative">
          <button class="text-neutral-600 hover:text-patient-500 transition-300">
            <i class="fa fa-bell text-xl"></i>
            <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-danger text-white text-xs rounded-full flex items-center justify-center"></span>
          </button>
        </div>
        <div>
          <button class="text-neutral-700 hover:text-patient-500 transition-300">
            <i class="fa fa-cog text-2xl"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 移动端菜单 -->
    <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-neutral-200">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center space-x-1 bg-neutral-100 rounded-full p-1 mb-4">
          <button class="flex-1 px-4 py-2 rounded-full text-sm font-medium bg-patient-500 text-white text-center transition-300">病人端</button>
        </div>
        <nav class="space-y-1">
          <a href="patient-home.html" class="block py-2 px-3 rounded-lg bg-patient-50 text-patient-700 font-medium">首页</a>
          <a href="patient-ai-consult.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">AI问诊</a>
          <a href="patient-doctor-book.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">预约医生</a>
          <a href="patient-medical-record.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">我的病历</a>
          <a href="patient-profile.html" class="block py-2 px-3 rounded-lg hover:bg-neutral-100 text-neutral-700 transition-300">个人中心</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-1 pt-16">
    <div class="container mx-auto px-4 py-6">
      <!-- 欢迎信息 - 动态显示用户名 -->
      <div class="mb-8 bg-gradient-to-r from-patient-500 to-patient-700 rounded-2xl p-6 text-white shadow-lg">
        <div>
          <h2 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold mb-2">
            您好，<span id="user-nickname" class="skeleton inline-block h-7"></span>
          </h2>
          <p class="text-patient-100 max-w-md">今天感觉怎么样？AI助手和专业医生随时为您提供帮助</p>
        </div>
      </div>

      <!-- 核心功能区（跳转入口） -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <a href="patient_ai.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-stethoscope text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">开始AI问诊</h3>
        </a>

        <a href="patient-doctor-book.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-calendar-check-o text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">预约医生</h3>
        </a>

        <a href="patient-medical-record.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-file-text-o text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">我的病历</h3>
        </a>

        <a href="patient-profile.html" class="bg-white rounded-xl p-5 shadow hover:shadow-lg transition-300 flex flex-col items-center text-center group">
          <div class="w-14 h-14 rounded-full bg-patient-100 flex items-center justify-center mb-3 group-hover:bg-patient-500 transition-300">
            <i class="fa fa-user-o text-patient-600 text-xl group-hover:text-white transition-300"></i>
          </div>
          <h3 class="font-medium text-neutral-800">个人中心</h3>
        </a>
      </div>

      <!-- 最近问诊 -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-neutral-800">最近问诊</h2>
          <a href="patient_chat_record.html" class="text-patient-600 hover:text-patient-700 text-sm font-medium flex items-center">
            全部记录 <i class="fa fa-angle-right ml-1"></i>
          </a>
        </div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <div class="divide-y divide-neutral-100" id="recent-consultation-container">
            <!-- 加载状态 -->
            <div id="loading-recent" class="p-6 text-center">
              <i class="fa fa-circle-o-notch fa-spin text-patient-500 text-xl mb-2"></i>
              <p class="text-neutral-500">加载最近问诊记录中...</p>
            </div>
            
            <!-- 空状态 (默认隐藏) -->
            <div id="empty-recent" class="hidden p-6 text-center">
              <div class="w-16 h-16 mx-auto bg-neutral-100 rounded-full flex items-center justify-center mb-3">
                <i class="fa fa-file-text-o text-neutral-400 text-2xl"></i>
              </div>
              <p class="text-neutral-500">暂无问诊记录</p>
            </div>
            
            <!-- 记录内容将通过JavaScript动态生成 -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 底部 -->
  <footer class="bg-white border-t border-neutral-200 py-6">
    <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
      <p>© 2024 医智通 版权所有 | 数据传输加密 隐私合规</p>
      <div class="flex justify-center space-x-4 mt-3">
        <a href="#" class="hover:text-patient-500 transition-300">隐私政策</a>
        <a href="#" class="hover:text-patient-500 transition-300">用户协议</a>
        <a href="#" class="hover:text-patient-500 transition-300">客服中心</a>
      </div>
    </div>
  </footer>

  <!-- 交互脚本 -->
  <script src="js/services/apiService.js"></script> 
  <script>
    // 移动端菜单切换
    document.getElementById('mobile-menu-btn').addEventListener('click', function() {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // 导航栏滚动效果
    window.addEventListener('scroll', function() {
      const header = document.querySelector('header');
      header.classList.toggle('shadow', window.scrollY > 10);
    });

    // 页面加载完成后获取用户信息和最近问诊记录
    document.addEventListener('DOMContentLoaded', function() {
      fetchUserInfo();
      fetchRecentConsultation();
    });

    // 获取当前登录用户信息函数
    function fetchUserInfo() {
      // 调用apiService中的getCurrentUser方法
      apiService.getCurrentUser()
        .then(userInfo => {
          // 更新页面显示的用户名
          const nicknameElement = document.getElementById('user-nickname');
          nicknameElement.textContent = userInfo.nickname;
          // 移除骨架屏样式
          nicknameElement.classList.remove('skeleton');
        })
        .catch(error => {
          console.error('加载用户信息失败:', error);
          // 出错时显示默认名称
          const nicknameElement = document.getElementById('user-nickname');
          nicknameElement.textContent = '用户';
          nicknameElement.classList.remove('skeleton');
        });
    }

    // 修改后的获取最近的问诊记录函数
    function fetchRecentConsultation() {
      // 直接调用获取最近一条记录的API
      apiService.getRecentMedicalRecord()
        .then(recentRecord => {
          renderRecentConsultation(recentRecord);
        })
        .catch(error => {
          console.error('加载最近问诊记录失败:', error);
          document.getElementById('loading-recent').innerHTML = `
            <div class="p-6 text-center">
              <i class="fa fa-exclamation-circle text-danger text-xl mb-2"></i>
              <p class="text-neutral-500">加载失败</p>
            </div>
          `;
        });
    }

    // 渲染最近的问诊记录
    function renderRecentConsultation(record) {
      const container = document.getElementById('recent-consultation-container');
      
      // 隐藏加载状态
      document.getElementById('loading-recent').remove();
      
      if (!record) {
        // 显示空状态
        document.getElementById('empty-recent').classList.remove('hidden');
        return;
      }
      
      // 根据记录类型(AI或医生)设置不同的图标和样式
      let iconHtml, typeText;
      if (record.type === 'ai') {
        // 使用"AI"文字作为头像图标
        iconHtml = '<div class="ai-initial">AI</div>';
        typeText = `${record.title}`;
      } else {
        iconHtml = '<i class="fa fa-user-md text-doctor-600"></i>';
        typeText = `${record.title} · ${record.department}`;
      }
      
      // 创建记录卡片
      const card = document.createElement('div');
      card.className = 'block p-4 hover:bg-neutral-50 transition-300 clickable-card';
      card.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full bg-patient-100 flex items-center justify-center mr-3">
              ${iconHtml}
            </div>
            <div>
              <h3 class="font-medium text-neutral-800">${typeText}</h3>
              <p class="text-neutral-500 text-sm">${record.date} ${record.time} ${record.doctor ? '· ' + record.doctor : ''}</p>
            </div>
          </div>
          <span class="px-2 py-1 bg-patient-100 text-patient-700 text-xs rounded-full">${record.status === 'completed' ? '已完成' : '进行中'}</span>
        </div>
        <p class="text-neutral-700 ml-13">${record.summary}</p>
      `;
      
      container.appendChild(card);
    }

    // 处理问诊记录点击事件
    document.querySelectorAll('.clickable-card').forEach(card => {
      card.addEventListener('click', function() {
        console.log('打开问诊记录:', this.getAttribute('href'));
      });
    });
  </script>
</body>
</html>
