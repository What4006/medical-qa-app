<html lang="zh-CN"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>医智通 - 病历详情</title>
  
  <!-- 基础样式与脚本 -->
  <!-- Tailwind CSS-->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Chart.js：如需添加数据可视化图表可使用，当前备用 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- 引入html2pdf.js库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Tailwind配置：自定义主题样式 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          // 自定义颜色方案
          colors: {
            patient: { // 病人端主色：淡蓝色系
              50: '#f0f7ff', 100: '#e0efff', 200: '#b9ddff', 
              300: '#7cc3fc', 400: '#3d9fe8', 500: '#0a84e3', 
              600: '#0066c7', 700: '#0052a3', 800: '#004382'
            },
            doctor: { // 医护端主色：淡青色系
              50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 
              300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 
              600: '#0d9488', 700: '#0f766e', 800: '#115e59'
            },
            // 功能色：成功、警告、危险
            success: '#10b981', warning: '#f59e0b', danger: '#ef4444'
          },
          // 字体配置：优先使用中文字体确保显示正常
          fontFamily: {
            sans: ['Microsoft YaHei', 'Source Han Sans CN', 'sans-serif']
          },
          // 自定义阴影效果：增强卡片层次感
          boxShadow: {
            'card': '0 4px 20px rgba(0, 0, 0, 0.05)', // 卡片默认阴影
            'card-hover': '0 8px 30px rgba(0, 0, 0, 0.1)', // 卡片悬停阴影
          }
        }
      }
    }
  </script>

  <!-- 自定义工具类：扩展Tailwind功能 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; } 
      .transition-300 { transition: all 300ms ease; } 
      .scrollbar-hide::-webkit-scrollbar { display: none; } 
      .backdrop-blur { backdrop-filter: blur(8px); } 
      .clickable-card { cursor: pointer; } 
      .ai-initial { @apply font-bold text-sm; } 
      
      /* 骨架屏样式：加载状态占位 */
      .skeleton { @apply bg-neutral-100 animate-pulse rounded; }
      .skeleton-line { @apply skeleton h-4 mb-2.5; }
      .skeleton-short { @apply w-1/3; } 
      .skeleton-medium { @apply w-2/3; } 
      .skeleton-long { @apply w-full; } 
      
      .badge-pill { @apply inline-flex items-center justify-center px-3 py-1.5 rounded-full text-sm font-medium; } 
      .record-checkbox { @apply transition-300; }
      
      /* 下拉菜单样式 */
      .dropdown-item { @apply px-3 py-2 rounded-lg text-sm hover:bg-patient-50 transition-300 cursor-pointer; }
      .dropdown-item.active { @apply bg-patient-100 text-patient-700 font-medium; }
      
      /* 病历记录样式 */
      .medical-record-title { @apply text-lg md:text-xl font-bold text-patient-700 mb-3 flex items-center; } 
      .medical-record-title::before { @apply content-[''] w-1.5 h-5 bg-patient-500 rounded-full mr-2; } 
      .medical-record-content { @apply text-neutral-700 leading-snug text-base; } 
      
      /* 病历区块样式 */
      .medical-section { @apply mb-8 pb-5 border-b border-neutral-100; } 
      .medical-section:last-child { @apply border-b-0 mb-0; } 
      
      .card-header-accent { @apply absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-patient-400 to-patient-600; } 

      /* 导出时强制显示所有内容 */
      .export-visible * {
        display: block !important;
        visibility: visible !important;
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
      }
    }
  </style>
</head>
<body class="bg-neutral-50 min-h-screen flex flex flex-col">
  <!-- 顶部导航栏：固定在顶部，包含返回按钮和页面标题 -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur shadow-sm transition-300">
    <div class="container mx-auto px-4 py-3.5 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <!-- 返回按钮：点击返回上一页 -->
        <button class="text-neutral-700 hover:text-patient-500 transition-300 p-1.5 rounded-full hover:bg-patient-50" onclick="history.back()">
          <i class="fa fa-arrow-left text-xl"></i>
        </button>
        <h1 class="text-xl font-bold text-neutral-800">病历详情</h1>
      </div>
    </div>
  </header>

  <!-- 主内容区：包含病历详情卡片，顶部留出导航栏高度的空间 -->
  <main class="flex-1 pt-16">
    <div class="container mx-auto px-4 py-6">
      <!-- 病历卡片：采用阴影和圆角设计，悬停时有微动效 -->
      <div class="relative bg-white rounded-xl shadow-card overflow-hidden mb-6 transform transition-all duration-300 hover:shadow-card-hover hover:-translate-y-1">
        <!-- 卡片顶部装饰条：增强视觉识别度 -->
        <div class="card-header-accent"></div>
        
        <!-- 卡片内容区：包含病历各类信息 -->
        <div class="p-6 md:p-8 pt-8">
          <!-- 病历信息头部：显示病历编号和创建日期 -->
          <div class="flex flex-wrap justify-between items-center mb-8 pb-4 border-b border-neutral-100">
            <div class="flex items-center space-x-2 text-neutral-500 text-sm">
              <i class="fa fa-file-text-o" style="min-width: 16px;"></i> <!-- 文件图标 -->
              <span id="record-id-container">
                <div class="skeleton h-4 w-40"></div> <!-- 加载状态骨架屏 -->
              </span>
            </div>
            <div class="flex items-center space-x-2 text-neutral-500 text-sm mt-2 sm:mt-0">
              <i class="fa fa-calendar" style="min-width: 16px;"></i> <!-- 日历图标 -->
              <span id="record-date-container">
                <div class="skeleton h-4 w-32"></div> <!-- 加载状态骨架屏 -->
              </span>
            </div>
          </div>
          
          <!-- 主诉区块 -->
          <div class="medical-section">
            <h3 class="medical-record-title">主诉</h3>
            <div id="chief-complaint-container">
              <div class="skeleton-container"> <!-- 加载状态 -->
                <div class="skeleton-line skeleton-medium"></div>
                <div class="skeleton-line skeleton-short"></div>
              </div>
              <p class="medical-record-content hidden" id="chief-complaint"></p> <!-- 实际内容（默认隐藏） -->
            </div>
          </div>
          
          <!-- 现病史区块 -->
          <div class="medical-section">
            <h3 class="medical-record-title">现病史</h3>
            <div id="present-illness-container">
              <div class="skeleton-container"> <!-- 加载状态 -->
                <div class="skeleton-line skeleton-long"></div>
                <div class="skeleton-line skeleton-long"></div>
                <div class="skeleton-line skeleton-medium"></div>
              </div>
              <p class="medical-record-content hidden" id="present-illness-history"></p> <!-- 实际内容 -->
            </div>
          </div>
          
          <!-- 既往史区块 -->
          <div class="medical-section">
            <h3 class="medical-record-title">既往史</h3>
            <div id="past-history-container">
              <div class="skeleton-container"> <!-- 加载状态 -->
                <div class="skeleton-line skeleton-long"></div>
                <div class="skeleton-line skeleton-medium"></div>
              </div>
              <p class="medical-record-content hidden" id="past-history"></p> <!-- 实际内容 -->
            </div>
          </div>
          
          <!-- 个人史区块 -->
          <div class="medical-section">
            <h3 class="medical-record-title">个人史</h3>
            <div id="personal-history-container">
              <div class="skeleton-container"> <!-- 加载状态 -->
                <div class="skeleton-line skeleton-long"></div>
                <div class="skeleton-line skeleton-long"></div>
              </div>
              <p class="medical-record-content hidden" id="personal-history"></p> <!-- 实际内容 -->
            </div>
          </div>
          
          <!-- 家族史区块 -->
          <div class="medical-section">
            <h3 class="medical-record-title">家族史</h3>
            <div id="family-history-container">
              <div class="skeleton-container"> <!-- 加载状态 -->
                <div class="skeleton-line skeleton-long"></div>
                <div class="skeleton-line skeleton-short"></div>
              </div>
              <p class="medical-record-content hidden" id="family-history"></p> <!-- 实际内容 -->
            </div>
          </div>
          
          <!-- 诊断结果区块 -->
          <div class="medical-section">
            <h3 class="medical-record-title">诊断</h3>
            <div id="diagnosis-container" class="flex flex-wrap gap-3 mt-3">
              <div class="skeleton-container"> <!-- 加载状态 -->
                <div class="skeleton h-9 w-40 rounded-full"></div>
              </div>
              <span class="badge-pill bg-success/10 text-success hidden" id="diagnosis-result"></span> <!-- 实际内容 -->
            </div>
          </div>
        </div>
        
        <!-- 卡片底部操作区：包含打印和导出功能 -->
        <div class="bg-neutral-50 px-6 py-4 border-t border-neutral-100 flex justify-center space-x-3">
          <button id="export-btn" class="px-4 py-2 text-sm text-neutral-600 hover:text-patient-600 transition-300 flex items-center">
            <i class="fa fa-download mr-1.5"></i> 导出
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- 底部导航：包含版权信息和链接 -->
  <footer class="bg-white border-t border-neutral-100 py-6 mt-8">
    <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
      <p>© 2024 医智通 版权所有 | 数据传输加密 隐私合规</p>
      <div class="flex justify-center space-x-6 mt-3">
        <a href="#" class="hover:text-patient-500 transition-300">隐私政策</a>
        <a href="#" class="hover:text-patient-500 transition-300">用户协议</a>
        <a href="#" class="hover:text-patient-500 transition-300">客服中心</a>
      </div>
    </div>
  </footer>

  <!-- 引入API服务：用于获取病历数据 -->
  <script src="js/services/apiService.js"></script>

  <!-- 前端交互脚本：处理数据加载和页面状态管理 -->
  <script>
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // 从URL参数获取病历ID，默认值为1
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('id') || 1;
        
        // 显示加载状态（骨架屏）
        showLoadingState();
        
        // 加载病历详情数据
        await loadMedicalRecordDetail(recordId);
        
        // 加载成功后显示实际内容
        showContentState();
        
      } catch (error) {
        console.error('初始化失败:', error.message);
        // 显示错误状态
        showErrorState();
        showErrorToast('加载病历详情失败，请重试');
      }
    });

    /**
     * 加载病历详情数据
     * @param {number} recordId - 病历ID
     */
    async function loadMedicalRecordDetail(recordId) {
      try {
        // 调用API服务获取病历详情
        const record = await apiService.getMedicalRecordDetail(recordId);
        
        if (!record) {
          throw new Error('未找到病历信息');
        }
        
        // 更新页面内容（使用API返回的数据）
        document.getElementById('chief-complaint').textContent = record.主诉 || '无';
        document.getElementById('present-illness-history').textContent = record.现病史 || '无';
        document.getElementById('past-history').textContent = record.既往史 || '无';
        document.getElementById('personal-history').textContent = record.个人史 || '无';
        document.getElementById('family-history').textContent = record.家族史 || '无';
        document.getElementById('diagnosis-result').textContent = record.诊断 || '未完成诊断';
        
        // 更新病历编号和创建时间（与其他信息保持一致的API调用方式）
        document.getElementById('record-id-container').innerHTML = 
          `病历编号: <span class="font-medium text-neutral-700">${record.id || '未知编号'}</span>`;
        document.getElementById('record-date-container').innerHTML = 
          `创建日期: <span class="font-medium text-neutral-700">${record.createdAt || '未知时间'}</span>`;
        
      } catch (error) {
        console.error('加载病历详情失败:', error.message);
        throw error; // 抛出错误，让上层处理
      }
    }

    /**
     * 显示加载状态：显示骨架屏，隐藏实际内容
     */
    function showLoadingState() {
      document.querySelectorAll('.skeleton-container, #record-id-container, #record-date-container').forEach(container => {
        container.classList.remove('hidden');
      });
      document.querySelectorAll('.medical-record-content, #diagnosis-result').forEach(el => {
        el.classList.add('hidden');
      });
    }

    /**
     * 显示内容状态：隐藏骨架屏，显示实际内容
     */
    function showContentState() {
      document.querySelectorAll('.skeleton-container').forEach(container => {
        container.classList.add('hidden');
      });
      document.querySelectorAll('.medical-record-content, #diagnosis-result').forEach(el => {
        el.classList.remove('hidden');
      });
    }

    /**
     * 显示错误状态：隐藏骨架屏，显示错误提示
     */
    function showErrorState() {
      document.querySelectorAll('.skeleton-container').forEach(container => {
        container.classList.add('hidden');
      });
      // 错误信息显示
      document.getElementById('record-id-container').innerHTML = 
        `病历编号: <span class="font-medium text-danger">加载失败</span>`;
      document.getElementById('record-date-container').innerHTML = 
        `创建日期: <span class="font-medium text-danger">加载失败</span>`;
      document.getElementById('chief-complaint').textContent = '加载失败';
      document.getElementById('present-illness-history').textContent = '加载失败';
      document.getElementById('past-history').textContent = '加载失败';
      document.getElementById('personal-history').textContent = '加载失败';
      document.getElementById('family-history').textContent = '加载失败';
      document.getElementById('diagnosis-result').textContent = '加载失败';
      
      // 显示错误内容并标红
      document.querySelectorAll('.medical-record-content, #diagnosis-result').forEach(el => {
        el.classList.remove('hidden');
        el.classList.add('text-danger');
      });
    }

    /**
     * 显示成功提示弹窗
     * @param {string} message - 提示信息
     */
    function showSuccessToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-success text-white px-6 py-3 rounded-lg shadow-lg flex items-center z-50 transition-300';
      toast.innerHTML = `<i class="fa fa-check-circle mr-2"></i><span>${message}</span>`;
      document.body.appendChild(toast);
      // 3秒后自动消失
      setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    /**
     * 显示错误提示弹窗
     * @param {string} message - 提示信息
     */
    function showErrorToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-danger text-white px-6 py-3 rounded-lg shadow-lg flex items-center z-50 transition-300';
      toast.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i><span>${message}</span>`;
      document.body.appendChild(toast);
      // 3秒后自动消失
      setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // 导出按钮点击事件
    document.getElementById('export-btn').addEventListener('click', async function() {
      try {

        // 1. 选择元素
        const recordCard = document.querySelector('.relative.bg-white.rounded-xl');
        const infoContainer = recordCard.querySelector('.flex.flex-wrap.justify-between.items-center');
        const idElement = document.getElementById('record-id-container').parentElement;
        const dateElement = document.getElementById('record-date-container').parentElement;
        const actionBar = recordCard.querySelector('.border-t.border-neutral-100');

        // 2. 保存原始样式
        const originalStyles = {
          infoContainer: { flexWrap: infoContainer.style.flexWrap, width: infoContainer.style.width },
          idElement: { flex: idElement.style.flex },
          dateElement: { flex: dateElement.style.flex },
          actionBar: { display: actionBar.style.display }
        };

        // 3. 临时调整样式
        infoContainer.style.flexWrap = 'nowrap';
        infoContainer.style.width = '100%';
        idElement.style.flex = '1';
        dateElement.style.flex = '1';
        actionBar.style.display = 'none';

        // 4. PDF配置（关键：调整分页逻辑）
        const opt = {
          margin: 15,
          filename: `病历-${document.querySelector('#record-id-container .font-medium').textContent}.pdf`,
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2, logging: false, scrollY: 0, scrollX: 0, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
          // 修复分页问题：仅避免内容被截断，不强制区块分页
          pagebreak: { mode: ['css', 'avoid-all'] }
        };

        // 5. 等待渲染
        await new Promise(resolve => setTimeout(resolve, 800));
        await html2pdf().from(recordCard).set(opt).save();

        // 6. 恢复样式
        infoContainer.style.flexWrap = originalStyles.infoContainer.flexWrap;
        infoContainer.style.width = originalStyles.infoContainer.width;
        idElement.style.flex = originalStyles.idElement.flex;
        dateElement.style.flex = originalStyles.dateElement.flex;
        actionBar.style.display = originalStyles.actionBar.display;

        showSuccessToast('PDF导出成功');
      } catch (error) {
        console.error('PDF导出失败:', error);
        showErrorToast('导出失败，请重试');
      }
    });
  </script>
</body></html>